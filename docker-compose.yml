version: "3.9"
services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    hostname: etcd-00
    command:
      - etcd
      - --name=etcd-00
      - --data-dir=data.etcd
      - --advertise-client-urls=http://etcd-00:2379,http://localhost:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --initial-advertise-peer-urls=http://etcd-00:2380,http://localhost:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster-state=new
      - --initial-cluster-token=etcd-cluster-1
  queue_server-1:
    hostname: queue-1
    build:
      context: .
      dockerfile: ./web-queue-server/Dockerfile
    environment:
      - RUST_LOG=info
      - QUEUES=test
      - SERVICE_DISCOVERY_BACKEND=etcd://etcd-00/web_queue
      - SERVICE_DISCOVERY_INSTANCE_ID=queue_server-1
      - SERVICE_DISCOVERY_INSTANCE_ADDR=http://queue-1:8080
    depends_on:
      - etcd
  queue_server-2:
    hostname: queue-2
    build:
      context: .
      dockerfile: ./web-queue-server/Dockerfile
    environment:
      - RUST_LOG=info
      - QUEUES=test
      - SERVICE_DISCOVERY_BACKEND=etcd://etcd-00/web_queue
      - SERVICE_DISCOVERY_INSTANCE_ID=queue_server-2
      - SERVICE_DISCOVERY_INSTANCE_ADDR=http://queue-2:8080
    depends_on:
      - etcd
  queue_proxy:
    build:
      context: .
      dockerfile: ./web-queue-proxy/Dockerfile
    ports:
      - "8081:8081"
    environment:
#      - DEFAULT_SHARDS=http://queue-1:8080;http://queue-2:8080
      - RUST_LOG=info
      - SERVICE_DISCOVERY_BACKEND=etcd://etcd-00/web_queue
    depends_on:
      - etcd